<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>QU·∫¢N L√ù UPS B·ªÜNH VI·ªÜN - B·∫¢O M·∫¨T CAO</title>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        :root {
            --primary: #1e3a8a; --green: #10b981; --bg: #f1f5f9;
        }
        * { box-sizing: border-box; font-family: "Times New Roman", Times, serif; }
        body { margin: 0; background: var(--bg); color: #1e293b; height: 100vh; display: flex; flex-direction: column; }

        /* Header */
        .header-banner {
            background: linear-gradient(135deg, var(--primary), var(--green));
            padding: 20px; text-align: center; color: white; position: relative;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .header-banner h1 { margin: 0; font-size: 1.8rem; text-transform: uppercase; letter-spacing: 2px; }
        
        #btnLockToggle {
            position: absolute; right: 20px; top: 50%; transform: translateY(-50%);
            padding: 8px 15px; background: rgba(255,255,255,0.2); border: 1px solid white;
            color: white; border-radius: 5px; cursor: pointer; font-weight: bold; transition: 0.3s;
        }
        #btnLockToggle:hover { background: white; color: var(--primary); }

        /* Modal nh·∫≠p m·∫≠t kh·∫©u */
        #authModal {
            display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.5); backdrop-filter: blur(5px);
        }
        .modal-content {
            background: white; margin: 15% auto; padding: 25px; border-radius: 15px;
            width: 320px; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }
        .modal-content h3 { margin-top: 0; color: var(--primary); }
        .modal-content input { width: 100%; padding: 10px; margin: 15px 0; border: 1px solid #ddd; border-radius: 8px; text-align: center; }
        .modal-btns { display: flex; gap: 10px; }
        .modal-btns button { flex: 1; padding: 10px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; }
        .btn-confirm { background: var(--green); color: white; }
        .btn-cancel { background: #e2e8f0; color: #64748b; }

        /* Navigation */
        .dept-nav { display: flex; background: white; justify-content: center; border-bottom: 2px solid #e2e8f0; }
        .dept-tab { padding: 12px 40px; cursor: pointer; font-weight: bold; font-size: 1.1rem; color: #64748b; transition: 0.3s; }
        .dept-tab.active { color: var(--primary); border-bottom: 3px solid var(--primary); background: #f8fafc; }

        .container { flex: 1; padding: 15px; max-width: 1500px; margin: auto; width: 100%; display: flex; flex-direction: column; overflow: hidden; }

        /* Toolbar */
        #toolbar {
            background: white; padding: 15px; border-radius: 12px;
            display: none; gap: 10px; align-items: center; margin-bottom: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05); border-left: 5px solid var(--green);
        }
        input, select { padding: 8px; border: 1px solid #e2e8f0; border-radius: 6px; outline: none; }
        .btn-add { background: var(--green); color: white; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer; font-weight: bold; }
        .btn-excel { background: #f59e0b; color: white; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer; font-weight: bold; margin-left: auto; }

        /* Table */
        .table-box { background: white; border-radius: 12px; flex: 1; overflow: hidden; display: flex; flex-direction: column; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .scroll { overflow-y: auto; flex: 1; padding: 0 10px; }
        table { width: 100%; border-collapse: separate; border-spacing: 0 8px; }
        thead th { position: sticky; top: 0; background: #f8fafc; padding: 12px; text-align: left; z-index: 10; color: var(--primary); border-bottom: 2px solid #e2e8f0; }
        
        tbody tr { transition: 0.3s; }
        tbody td { background: white; padding: 10px 15px; border-top: 1px solid #f1f5f9; border-bottom: 1px solid #f1f5f9; font-size: 1.1rem; }
        tbody tr:hover { transform: translateY(-2px); }
        tbody tr:hover td { background: #f0fdf4; box-shadow: 0 4px 8px rgba(0,0,0,0.05); }

        .tag { padding: 3px 8px; border-radius: 4px; color: white; font-weight: bold; font-size: 0.8rem; }
        .tag-t1 { background: #3b82f6; }
        .tag-t3 { background: #10b981; }
        
        .col-del { display: none; }
        .btn-del { color: #ef4444; border: none; background: none; cursor: pointer; font-weight: bold; }
        .unlocked { border: 1px dashed var(--green) !important; background: #fafdfb !important; }

    </style>
</head>
<body>

<div id="authModal">
    <div class="modal-content">
        <h3>X√ÅC TH·ª∞C QU·∫¢N TR·ªä</h3>
        <input type="password" id="passInput" placeholder="Nh·∫≠p m·∫≠t kh·∫©u...">
        <div class="modal-btns">
            <button class="btn-cancel" onclick="closeModal()">H·ª¶Y</button>
            <button class="btn-confirm" onclick="checkAuth()">X√ÅC NH·∫¨N</button>
        </div>
    </div>
</div>

<div class="header-banner">
    <h1>TH·ªêNG K√ä H·ªÜ TH·ªêNG UPS</h1>
    <button id="btnLockToggle" onclick="openModal()">üîì M·ªû KH√ìA</button>
</div>

<div class="dept-nav">
    <div class="dept-tab active" onclick="switchDept('X√©t Nghi·ªám', this)">KHOA X√âT NGHI·ªÜM</div>
    <div class="dept-tab" onclick="switchDept('Gi·∫£i Ph·∫´u B·ªánh', this)">KHOA GI·∫¢I PH·∫™U B·ªÜNH</div>
</div>

<div class="container">
    <div id="toolbar">
        <select id="floor">
            <option value="T·∫ßng 1">T·∫ßng 1</option>
            <option value="T·∫ßng 3">T·∫ßng 3</option>
        </select>
        <input type="text" id="dev" placeholder="T√™n thi·∫øt b·ªã..." style="flex:2">
        <input type="text" id="model" placeholder="Model UPS..." style="flex:1">
        <input type="text" id="sn" placeholder="S·ªë Serial UPS..." style="flex:1">
        <button class="btn-add" onclick="saveData()">+ TH√äM</button>
        <button class="btn-excel" onclick="exportData()">üìä EXCEL</button>
    </div>

    <div class="table-box">
        <div class="scroll">
            <table id="upsTable">
                <thead>
                    <tr>
                        <th width="100px">V·ªã tr√≠</th>
                        <th>T√™n M√°y Thi·∫øt B·ªã</th>
                        <th width="200px">Model UPS</th>
                        <th width="200px">S·ªë Serial UPS</th>
                        <th class="col-del" width="50px">X√≥a</th>
                    </tr>
                </thead>
                <tbody id="tbody"></tbody>
            </table>
        </div>
    </div>
</div>

<script>
    let currentDept = 'X√©t Nghi·ªám';
    let isUnlocked = false;
    const config = { databaseURL: "https://hautruong3339-c2db4-default-rtdb.firebaseio.com/" };
    firebase.initializeApp(config);
    const db = firebase.database().ref("ups_system");

    // Modal logic
    function openModal() {
        if (isUnlocked) {
            location.reload(); // Kh√≥a l·∫°i b·∫±ng c√°ch load trang
        } else {
            document.getElementById('authModal').style.display = "block";
            document.getElementById('passInput').focus();
        }
    }

    function closeModal() {
        document.getElementById('authModal').style.display = "none";
        document.getElementById('passInput').value = "";
    }

    function checkAuth() {
        const pass = document.getElementById('passInput').value;
        if (pass === "vt123") {
            isUnlocked = true;
            document.getElementById('btnLockToggle').innerText = "üîí KH√ìA L·∫†I";
            document.getElementById('btnLockToggle').style.background = "#ef4444";
            document.getElementById('toolbar').style.display = "flex";
            document.querySelectorAll('.col-del').forEach(el => el.style.display = "table-cell");
            closeModal();
            load();
        } else {
            alert("M·∫≠t kh·∫©u kh√¥ng ch√≠nh x√°c!");
            document.getElementById('passInput').value = "";
        }
    }

    // Enter key to confirm
    document.getElementById('passInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') checkAuth();
    });

    function switchDept(dept, btn) {
        currentDept = dept;
        document.querySelectorAll('.dept-tab').forEach(t => t.classList.remove('active'));
        btn.classList.add('active');
        const floorSel = document.getElementById('floor');
        if(dept === 'Gi·∫£i Ph·∫´u B·ªánh') {
            floorSel.innerHTML = '<option value="T·∫ßng 3">T·∫ßng 3</option>';
        } else {
            floorSel.innerHTML = '<option value="T·∫ßng 1">T·∫ßng 1</option><option value="T·∫ßng 3">T·∫ßng 3</option>';
        }
        load();
    }

    function load() {
        db.child(currentDept).on('value', snap => {
            const tbody = document.getElementById('tbody');
            tbody.innerHTML = "";
            let dataArr = [];
            const data = snap.val();
            if(data) {
                Object.keys(data).forEach(id => dataArr.push({ id, ...data[id] }));
                dataArr.sort((a, b) => {
                    if (a.floor !== b.floor) return a.floor === 'T·∫ßng 1' ? -1 : 1;
                    return b.id.localeCompare(a.id);
                });

                dataArr.forEach(item => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td><span class="tag ${item.floor === 'T·∫ßng 1' ? 'tag-t1' : 'tag-t3'}">${item.floor}</span></td>
                        <td class="${isUnlocked ? 'unlocked' : ''}" contenteditable="${isUnlocked}" onblur="update('${item.id}','dev',this.innerText)">${item.dev}</td>
                        <td class="${isUnlocked ? 'unlocked' : ''}" contenteditable="${isUnlocked}" onblur="update('${item.id}','model',this.innerText)">${item.model}</td>
                        <td class="${isUnlocked ? 'unlocked' : ''}" contenteditable="${isUnlocked}" onblur="update('${item.id}','sn',this.innerText)">${item.sn}</td>
                        <td class="col-del" style="display:${isUnlocked ? 'table-cell' : 'none'}">
                            <button class="btn-del" onclick="remove('${item.id}')">‚úï</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            }
        });
    }

    function saveData() {
        const floor = document.getElementById('floor').value;
        const dev = document.getElementById('dev').value;
        const model = document.getElementById('model').value;
        const sn = document.getElementById('sn').value;
        if(!dev || !isUnlocked) return alert("Vui l√≤ng m·ªü kh√≥a tr∆∞·ªõc khi th√™m!");
        db.child(currentDept).push({ floor, dev, model, sn });
        document.getElementById('dev').value = ""; document.getElementById('model').value = ""; document.getElementById('sn').value = "";
    }

    function update(id, field, val) { if(isUnlocked) db.child(currentDept).child(id).update({ [field]: val }); }
    function remove(id) { if(isUnlocked && confirm("X√°c nh·∫≠n x√≥a?")) db.child(currentDept).child(id).remove(); }

    function exportData() {
        const rows = Array.from(document.getElementById("upsTable").rows).filter(r => r.style.display !== 'none');
        const ws_data = rows.map(r => Array.from(r.cells).slice(0, 4).map(c => c.innerText));
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.aoa_to_sheet(ws_data);
        XLSX.utils.book_append_sheet(wb, ws, "Data");
        XLSX.writeFile(wb, `UPS_${currentDept}.xlsx`);
    }

    load();
</script>
</body>
</html>
