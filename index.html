<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>H·ªÜ TH·ªêNG QU·∫¢N L√ù UPS - KHOA XN & GPB</title>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        :root {
            --blue: #2563eb;
            --green: #10b981;
            --navy: #1e3a8a;
            --bg: #f8fafc;
        }

        * { box-sizing: border-box; font-family: "Times New Roman", Times, serif; }
        body { margin: 0; background: var(--bg); color: #1e293b; height: 100vh; display: flex; flex-direction: column; }

        /* Ti√™u ƒë·ªÅ */
        .main-header {
            background: linear-gradient(135deg, var(--navy), var(--green));
            color: white; padding: 20px; text-align: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .main-header h1 { margin: 0; font-size: 2rem; letter-spacing: 2px; text-transform: uppercase; }

        /* Tab khoa */
        .nav-container { display: flex; justify-content: center; background: white; padding: 10px; gap: 15px; border-bottom: 2px solid #e2e8f0; }
        .tab-btn {
            padding: 10px 35px; cursor: pointer; font-weight: bold; font-size: 1.1rem;
            border-radius: 10px; border: none; background: #f1f5f9; color: #64748b;
            transition: 0.3s; box-shadow: inset 2px 2px 5px #d1d9e6;
        }
        .tab-btn.active {
            background: white; color: var(--blue);
            box-shadow: 4px 4px 10px rgba(0,0,0,0.1);
            border: 1px solid var(--blue);
        }

        .container { flex: 1; padding: 15px; max-width: 1500px; margin: auto; width: 100%; display: flex; flex-direction: column; overflow: hidden; }

        /* Filter bar */
        .filter-bar { display: flex; gap: 10px; margin-bottom: 12px; align-items: center; }
        .filter-item {
            padding: 6px 18px; background: white; border-radius: 20px;
            cursor: pointer; font-weight: bold; border: 1px solid #cbd5e1; transition: 0.3s;
        }
        .filter-item.active { background: var(--blue); color: white; border-color: var(--blue); }

        /* Toolbar nh·∫≠p li·ªáu */
        .toolbar {
            background: white; padding: 15px; border-radius: 12px;
            display: flex; gap: 10px; align-items: center; margin-bottom: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05); border-left: 5px solid var(--green);
        }
        input, select { padding: 10px; border: 1px solid #e2e8f0; border-radius: 6px; outline: none; font-size: 1rem; }
        .btn-add { background: var(--green); color: white; border: none; border-radius: 6px; padding: 10px 20px; cursor: pointer; font-weight: bold; }
        .btn-excel { background: #f59e0b; color: white; border: none; border-radius: 6px; padding: 10px 20px; cursor: pointer; font-weight: bold; margin-left: auto; }

        /* B·∫£ng hi·ªÉn th·ªã */
        .table-box { background: white; border-radius: 12px; flex: 1; overflow: hidden; display: flex; flex-direction: column; box-shadow: 0 10px 15px rgba(0,0,0,0.05); }
        .scroll { overflow-y: auto; flex: 1; padding: 0 10px; }
        table { width: 100%; border-collapse: separate; border-spacing: 0 8px; }
        thead th { position: sticky; top: 0; background: #f8fafc; padding: 15px; text-align: left; z-index: 10; color: var(--navy); border-bottom: 2px solid #e2e8f0; }
        
        tbody tr { transition: 0.3s; }
        tbody td { background: white; padding: 12px 15px; border-top: 1px solid #f1f5f9; border-bottom: 1px solid #f1f5f9; font-size: 1.1rem; }
        tbody td:first-child { border-left: 1px solid #f1f5f9; border-radius: 10px 0 0 10px; }
        tbody td:last-child { border-right: 1px solid #f1f5f9; border-radius: 0 10px 10px 0; }

        /* Hi·ªáu ·ª©ng kh·ªëi */
        tbody tr:hover { transform: scale(1.005); }
        tbody tr:hover td {
            background: #f0fdf4;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            color: #166534;
            border-color: var(--green);
        }

        .tag { padding: 3px 10px; border-radius: 5px; color: white; font-weight: bold; font-size: 0.85rem; }
        .tag-t1 { background: var(--blue); }
        .tag-t3 { background: var(--green); }
        .btn-del { color: #ef4444; border: none; background: none; cursor: pointer; font-weight: bold; }
    </style>
</head>
<body>

<div class="main-header">
    <h1>TH·ªêNG K√ä H·ªÜ TH·ªêNG UPS B·ªÜNH VI·ªÜN</h1>
</div>

<div class="nav-container">
    <button class="tab-btn active" onclick="switchDept('X√©t Nghi·ªám', this)">KHOA X√âT NGHI·ªÜM</button>
    <button class="tab-btn" onclick="switchDept('Gi·∫£i Ph·∫´u B·ªánh', this)">KHOA GI·∫¢I PH·∫™U B·ªÜNH</button>
</div>

<div class="container">
    <div class="filter-bar">
        <div id="btn-all" class="filter-item active" onclick="setFilter('all', this)">T·∫•t c·∫£ m√°y</div>
        <div id="btn-t1" class="filter-item" onclick="setFilter('T·∫ßng 1', this)">T·∫ßng 1</div>
        <div id="btn-t3" class="filter-item" onclick="setFilter('T·∫ßng 3', this)">T·∫ßng 3</div>
    </div>

    <div class="toolbar">
        <select id="floor">
            <option value="T·∫ßng 1">T·∫ßng 1</option>
            <option value="T·∫ßng 3">T·∫ßng 3</option>
        </select>
        <input type="text" id="dev" placeholder="T√™n thi·∫øt b·ªã..." style="flex:2">
        <input type="text" id="model" placeholder="Model UPS..." style="flex:1">
        <input type="text" id="sn" placeholder="S·ªë Serial UPS..." style="flex:1">
        <button class="btn-add" onclick="saveData()">+ TH√äM M·ªöI</button>
        <button class="btn-excel" onclick="exportData()">üìä XU·∫§T EXCEL</button>
    </div>

    <div class="table-box">
        <div class="scroll">
            <table id="upsTable">
                <thead>
                    <tr>
                        <th width="100px">V·ªã tr√≠</th>
                        <th>T√™n M√°y Thi·∫øt B·ªã</th>
                        <th width="250px">Model UPS</th>
                        <th width="250px">S·ªë Serial UPS</th>
                        <th width="50px"></th>
                    </tr>
                </thead>
                <tbody id="tbody"></tbody>
            </table>
        </div>
    </div>
</div>

<script>
    let currentDept = 'X√©t Nghi·ªám';
    let currentFilter = 'all';
    const config = { databaseURL: "https://hautruong3339-c2db4-default-rtdb.firebaseio.com/" };
    firebase.initializeApp(config);
    const db = firebase.database().ref("ups_system");

    function switchDept(dept, btn) {
        currentDept = dept;
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        
        const btnT1 = document.getElementById('btn-t1');
        const floorSel = document.getElementById('floor');
        
        if(dept === 'Gi·∫£i Ph·∫´u B·ªánh') {
            btnT1.style.display = 'none';
            floorSel.innerHTML = '<option value="T·∫ßng 3">T·∫ßng 3</option>';
            setFilter('T·∫ßng 3', document.getElementById('btn-t3'));
        } else {
            btnT1.style.display = 'block';
            floorSel.innerHTML = '<option value="T·∫ßng 1">T·∫ßng 1</option><option value="T·∫ßng 3">T·∫ßng 3</option>';
            setFilter('all', document.getElementById('btn-all'));
        }
        load();
    }

    function load() {
        db.child(currentDept).on('value', snap => {
            const tbody = document.getElementById('tbody');
            tbody.innerHTML = "";
            let dataArr = [];
            const data = snap.val();
            
            if(data) {
                Object.keys(data).forEach(id => {
                    dataArr.push({ id, ...data[id] });
                });

                // T·ª∞ ƒê·ªòNG S·∫ÆP X·∫æP T·∫¶NG 1 L√äN TR∆Ø·ªöC
                dataArr.sort((a, b) => {
                    if (a.floor === 'T·∫ßng 1' && b.floor !== 'T·∫ßng 1') return -1;
                    if (a.floor !== 'T·∫ßng 1' && b.floor === 'T·∫ßng 1') return 1;
                    return 0;
                });

                dataArr.forEach(item => {
                    const row = document.createElement('tr');
                    row.setAttribute('data-floor', item.floor);
                    row.innerHTML = `
                        <td><span class="tag ${item.floor === 'T·∫ßng 1' ? 'tag-t1' : 'tag-t3'}">${item.floor}</span></td>
                        <td contenteditable="true" onblur="update('${item.id}','dev',this.innerText)">${item.dev}</td>
                        <td contenteditable="true" onblur="update('${item.id}','model',this.innerText)">${item.model}</td>
                        <td contenteditable="true" onblur="update('${item.id}','sn',this.innerText)">${item.sn}</td>
                        <td><button class="btn-del" onclick="remove('${item.id}')">‚úï</button></td>
                    `;
                    tbody.appendChild(row);
                });
            }
            applyFilter();
        });
    }

    function setFilter(val, btn) {
        currentFilter = val;
        document.querySelectorAll('.filter-item').forEach(i => i.classList.remove('active'));
        btn.classList.add('active');
        applyFilter();
    }

    function applyFilter() {
        document.querySelectorAll('#tbody tr').forEach(r => {
            r.style.display = (currentFilter === 'all' || r.getAttribute('data-floor') === currentFilter) ? '' : 'none';
        });
    }

    function saveData() {
        const floor = document.getElementById('floor').value;
        const dev = document.getElementById('dev').value;
        const model = document.getElementById('model').value;
        const sn = document.getElementById('sn').value;
        if(!dev) return alert("Vui l√≤ng nh·∫≠p t√™n m√°y!");
        db.child(currentDept).push({ floor, dev, model, sn });
        document.getElementById('dev').value = ""; document.getElementById('model').value = ""; document.getElementById('sn').value = "";
    }

    function update(id, field, val) { db.child(currentDept).child(id).update({ [field]: val }); }
    function remove(id) { if(confirm("X√≥a m√°y n√†y?")) db.child(currentDept).child(id).remove(); }

    function exportData() {
        const table = document.getElementById("upsTable");
        const rows = Array.from(table.rows).filter(r => r.style.display !== 'none');
        
        const ws_data = rows.map(r => Array.from(r.cells).slice(0, 4).map(c => c.innerText));
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.aoa_to_sheet(ws_data);
        XLSX.utils.book_append_sheet(wb, ws, "D·ªØ li·ªáu");
        
        const fileName = currentFilter === 'all' ? `UPS_TatCa_${currentDept}.xlsx` : `UPS_${currentFilter}_${currentDept}.xlsx`;
        XLSX.writeFile(wb, fileName);
    }

    load();
</script>
</body>
</html>
